<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>dual-Infodose Chat Cinematogr√°fico</title>
<!-- Fonte Montserrat otimizada -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&amp;display=swap" rel="stylesheet"/>
<script defer="" src="config/config.js">function detectarPulsoSimbolico(inputTexto) {
  const simbolos = ['Œî', '‚ö°', 'üß†', 'üëÅÔ∏è'];
  const encontrados = simbolos.filter(s => inputTexto.includes(s));
  if (encontrados.length) {
    console.log('Pulso simb√≥lico detectado:', encontrados.join(', '));
  }
}
</script>
<script defer="" src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js">function detectarPulsoSimbolico(inputTexto) {
  const simbolos = ['Œî', '‚ö°', 'üß†', 'üëÅÔ∏è'];
  const encontrados = simbolos.filter(s => inputTexto.includes(s));
  if (encontrados.length) {
    console.log('Pulso simb√≥lico detectado:', encontrados.join(', '));
  }
}
</script>
<style>
    :root {
      --bg: linear-gradient(to bottom, #000, #1a1a1a);
      --text: #d7d7d7;
      --fast: .4s; --med: .8s; --slow: 1.8s;
    }
    body.light  { --bg: linear-gradient(to bottom,#666,#e0e0e0); --text:#444; }
    body.medium { --bg: linear-gradient(to bottom,#555,#333);   --text:#eee; }
    body.vibe   { --bg: linear-gradient(135deg,#00d8d8,#d800d8); --text:#fff; }
    * { box-sizing:border-box; margin:0; padding:0; }
    html, body { width:100%; height:100%; overflow:hidden; }
    body {
      display:flex; flex-direction:column; align-items:center;
      padding:20px; background:var(--bg); color:var(--text);
      font-family:'Montserrat',sans-serif;
      transition:background var(--slow), color var(--slow);
      animation:fadeIn var(--slow) ease forwards;
    }
    @keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
    @keyframes clickPulse{0%,100%{opacity:1}50%{opacity:0.7}}
    @keyframes expandFooter{0%,100%{transform:scale(1)}50%{transform:scale(0.96)}}
    @keyframes moveGradient{0%{background-position:0% 50%}100%{background-position:200% 50%}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.012)}}

    /* Bot√µes */
    .copy-button, .paste-button, .toggle-button, .kitty-button, .history-button {
      width:36px; height:36px; border:none; border-radius:50%;
      background:rgba(255,255,255,0.06); display:flex;
      align-items:center; justify-content:center; cursor:pointer;
      transition:background var(--fast), opacity var(--slow);
      opacity:.7;
    }
    .copy-button:hover, .paste-button:hover,
    .toggle-button:hover, .kitty-button:hover, .history-button:hover {
      background:rgba(255,255,255,0.15);
    }
    .toggle-button.active, .kitty-button.active, .history-button.active { opacity:1; }

    /* Logo */
    .svg-container {
      position:absolute; top:269px; left:50%; width:180px; height:180px;
      transform:translateX(-50%); z-index:1;
      filter:drop-shadow(0 0 10px rgba(0,255,255,0.15));
      transition:opacity var(--slow);
    }
    .svg-container.fading { opacity:0; }
    .svg-container object {
      width:100%; height:100%; object-fit:contain;
      animation:pulse 2s infinite ease-in-out;
      transition:opacity var(--med) ease;
    }

    /* Pagina√ß√£o */
    .pagination button {
      border:none; background:linear-gradient(45deg,#0ff,#f0f);
      background-clip:text; -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-size:1.2em; cursor:pointer; transition:transform var(--fast);
    }
    .pagination button:hover{ transform:scale(1.2) }

    /* Blocos de resposta */
    .response-block{
      margin:1rem 0; padding:1.3rem; border-radius:6px;
      line-height:1.8; position:relative; overflow:hidden;
      animation:fadeIn var(--slow) ease forwards,pulse 12s infinite ease-in-out;
      transition:box-shadow var(--fast),transform var(--fast);
    }
    .response-block:hover{ box-shadow:0 0 15px rgba(0,255,255,.4) }
    .response-block.clicked{ animation:clickPulse var(--med) ease-out }
    .response-block.expanded{
      transform:scale(1.03); background:rgba(0,0,0,.6); z-index:2;
    }
    .intro{ background:linear-gradient(135deg,rgba(0,255,255,.2),rgba(0,100,100,.1)); border-left:4px solid #0ff }
    .middle{ background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(50,50,50,.1)); border-left:4px solid rgba(255,255,255,.4) }
    .ending{ background:linear-gradient(135deg,rgba(255,0,255,.2),rgba(100,0,100,.1)); border-left:4px solid #f0f }

    /* C√≥digo block */
    .code-block {
      position:relative; background:rgba(0,0,0,0.6);
      padding:1rem; border-radius:8px; font-family:monospace;
      overflow-x:auto; margin:1rem 0;
    }
    .code-block pre{ margin:0; white-space:pre-wrap; word-break:break-word; }
    .code-block button.copy-code {
      position:absolute; top:8px; right:8px;
      background:rgba(255,255,255,0.1); border:none;
      padding:4px 8px; border-radius:4px; cursor:pointer;
      font-size:0.8em; color:var(--text);
    }

    /* Containers */
    #themeToggle{ position:absolute; top:60px; left:50%; transform:translateX(-50%);
      width:30px; height:30px; border:1px solid var(--text); border-radius:50%;
      background:transparent; opacity:.3; cursor:pointer;
      transition:opacity var(--med),border-color var(--med); z-index:10;
    }
    #themeToggle:hover { opacity: 0.8 }
    #themeToggle::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--text);
      opacity: 0.2;
    }
    #particles-js{ position:absolute; inset:0; z-index:0; }

    #assistantName{ margin-top:199px; font-size:1.1em; font-weight:600; opacity:.8;
      transition:opacity var(--slow);
    }

    .response-container{
      position:fixed; left:20px; right:20px; bottom:160px; padding:6px;
      background:rgba(0,0,0,0.3); backdrop-filter:blur(8px);
      border-radius:20px; max-height:calc(100vh - 200px);
      overflow-y:auto; z-index:1; transition:background var(--slow);
      animation:fadeIn var(--slow) ease forwards;
    }
    body.light  .response-container{ background:rgba(255,255,255,0.3); }
    body.medium .response-container{ background:rgba(0,0,0,0.2); }
    body.vibe   .response-container{ background:rgba(255,255,255,0.2); }

    .pages-wrapper{ transition:opacity var(--slow),height var(--slow); }
    .pages-wrapper.collapsed{ display:none; }
    .page{ display:none; opacity:0; transition:opacity var(--slow); }
    .page.active{ display:block; opacity:1; }
    .page.initial{ display:flex; align-items:center; justify-content:center;
      height:100%; text-align:center;
    }

    .footer-text{
      display:block; margin:6px auto; padding:6px 6px;
      background:var(--bg); opacity:.5; color:var(--text);
      font-size:0.8em; text-align:center; font-style:italic;
      border-radius:6px; cursor:pointer;
      transition:opacity var(--slow),transform var(--slow);
      animation:moveGradient 8s linear infinite;
    }
    .footer-text.loading{ background:transparent!important; backdrop-filter:none!important; }
    .footer-text.loading span{ background:none!important; }
    .footer-text:hover{ opacity:.6; }
    .footer-text.active{ opacity:.8; animation:expandFooter var(--med) ease-out; }

    .response-controls{ display:flex; justify-content:space-between; align-items:center;
      margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.2);
    }
    body.light  .response-controls{ border-top-color:rgba(0,0,0,0.2); }
    body.medium .response-controls{ border-top-color:rgba(255,255,255,0.2); }
    body.vibe   .response-controls{ border-top-color:rgba(0,0,0,0.4); }

    .control-buttons, .pagination{ display:flex; align-items:center; gap:10px; }

    #sendBtn{
      width:60px; height:60px; font-size:48px;
      background:linear-gradient(42deg,#0ff,#f0f);
      border:none; background-clip:text;
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:transform var(--med),opacity var(--slow);
      opacity:.9;
    }
    #sendBtn:hover{ transform:scale(1.1); opacity:1; }

    #voiceBtn{
      width:60px; height:60px; border:none; border-radius:50%;
      background:rgba(255,255,255,0.06); display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; transition:background var(--fast),opacity var(--slow);
      opacity:.7;
    }
    #voiceBtn:hover{ background:rgba(255,255,255,0.15); opacity:1; }
    .input-container{
      position:fixed;left:20px;right:20px;bottom:90px;
      display:flex;gap:6px;z-index:2;
    }
    .input-container input{
      flex:1;padding:10px;border:none;border-radius:20px;
      background:rgba(255,255,255,.1);color:inherit;font-size:16px;
      transition:background var(--fast);opacity:0.7;
    }
    .input-container input:focus{background:rgba(255,255,255,.2)}
    .input-container button{
      width:60px;height:60px;border:none;
      background:linear-gradient(42deg,#0ff,#f0f);
      background-clip:text;-webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-size:48px;cursor:pointer;animation:pulse 2s infinite ease-in-out;
      display:flex;align-items:center;justify-content:center;
      transition:transform var(--med);opacity:.7;
    }
    .input-container button:hover{transform:scale(1.1)}
    
    .login-container{ display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:300px; padding:1.5rem 1rem; background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.15); border-radius:10px; backdrop-filter:blur(8px);
      z-index:10; role:dialog; aria-modal:true;
    }
    .login-container.active{ display:block; }
    .login-container input{
      width:100%; background:transparent; border:none;
      border-bottom:1px solid rgba(255,255,255,0.3);
      margin:.8rem 0; padding:.4rem 0; font-size:.95em; color:#fff;
    }
    .login-container input::placeholder{ color:rgba(255,255,255,0.5); }
    .login-container button{
      width:100%; margin-top:1rem; padding:.5rem 0;
      border:1px solid #0ff; border-radius:8px;
      background:transparent; font-size:.95em; color:#0ff; cursor:pointer;
      transition:background .25s,color .25s;
    }
    .login-container button:hover{ background:#0ff; color:#000; }
  
#bootText.pulse::after {
  content: attr(data-text);
  position: absolute;
  inset: 0;
  background: linear-gradient(42deg, #0ff, #f0f);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: blur(4px);
  opacity: 0.4;
  pointer-events: none;
  animation: pulseGlow 3s ease-in-out infinite;
}
#bootText {
  display: inline-block;
  position: relative;
  font-weight: bold;
}
@keyframes pulseGlow {
  0%,100% { opacity: 0.4; }
  50% { opacity: 0.8; }
}

</style>
<link href="manifest.json" rel="manifest"/>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('serviceWorker.js')
    .then(() => console.log("‚úîÔ∏è Service Worker registrado"))
    .catch(err => console.error("‚ùå Service Worker falhou:", err));
}
</script>
<link href="manifest.json" rel="manifest"/><meta content="#000000" name="theme-color"/>
<style>
#toggleTimeline:hover, #soulAvatar:hover, #faceBtn:hover,
#toggleTimeline:active, #soulAvatar:active, #faceBtn:active {
  opacity: 1 !important;
  transform: scale(1.05);
}
</style>
<style>
@keyframes pulseGlow {
  0%, 100% { box-shadow:0 0 6px #0ff, 0 0 6px #f0f, 0 0 10px #0ff inset; opacity:0.9; }
  50% { box-shadow:0 0 12px #0ff, 0 0 12px #f0f, 0 0 18px #f0f inset; opacity:1; }
}
</style>
<style>
@keyframes pulseGlow {
  0%, 100% { box-shadow:0 0 6px #0ff, 0 0 6px #f0f; opacity: 0.85; }
  50% { box-shadow:0 0 12px #0ff, 0 0 12px #f0f; opacity: 1; }
}
</style>
<style>
@keyframes pulseDot {
  0%, 100% { opacity: 0.25; transform: translateX(-50%) scale(1); }
  50% { opacity: 0.6; transform: translateX(-50%) scale(1.5); }
}
</style>
</head>
<body><canvas id="emotionCanvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;opacity:0.25;"></canvas>
<div style="position:fixed;top:10px;right:10px;z-index:999;">
<select id="themeSelector" onchange="applyThemeSelector(this.value)">
<option value="dark">üåë Dark</option>
<option value="light">üåû Light</option>
<option value="medium">üåì Medium</option>
<option value="vibe">üåà Vibe</option>
<option value="cyberpunk">‚ò£Ô∏è Cyberpunk</option>
<option value="anime">üå∏ Anime</option>
</select>
</div>
<script>
    function applyThemeSelector(val){
      const body = document.body;
      body.classList.remove('light','medium','vibe','dark','cyberpunk','anime');
      if(val !== 'dark') body.classList.add(val);
      localStorage.setItem('infodoseTheme', val);
    }
    </script>
<button aria-label="Alternar tema" id="themeToggle" title="Alternar tema"></button>
<div id="particles-js"></div>
<div class="svg-container" id="logoContainer">
<object data="assets/icons/pill_Dual.png" id="logoObj" type="image/png"></object>
</div>
<div aria-live="polite" id="assistantName"></div>
<div class="response-container" id="response">
<div class="pages-wrapper">
<div class="page initial active">
<strong data-text="üß¨ Iniciando... Pulso simbi√≥tico detectado. Presen√ßa reconhecida." id="bootText"></strong>
</div>
</div>
<p class="footer-text"><em>Do seu jeito. <strong>Sempre</strong> √∫nico. <strong>Sempre</strong> seu.</em></p>
<div class="response-controls">
<div class="control-buttons">
<button class="copy-button" title="Copiar"><object data="assets/icons/BW_quad_Dual_Infodose.svg" height="27" type="image/svg+xml" width="27"></object></button>
<button class="paste-button" title="Colar"><object data="assets/icons/BW_Dual_Infodose.svg" height="24" type="image/svg+xml" width="24"></object></button>
<button class="toggle-button" id="toggleBtn" title="Login"><object data="assets/icons/pill_Dual_3.png" height="28" type="image/png" width="28"></object></button>
<button class="kitty-button" id="kittyBtn" title="Estudos"><object data="assets/icons/DualKittyKard-icon-3.png" height="33" type="image/png" width="33"></object></button>
<button class="history-button" id="historyBtn" title="Modo Hist√≥ria"><object data="assets/icons/Ancora_Dual_Infodose.svg" height="24" type="image/svg+xml" width="24"></object></button>
</div>
<div class="pagination">
<button aria-label="P√°gina anterior" data-action="prev">‚üµ</button>
<span id="pageIndicator">1 / 1</span>
<button aria-label="Pr√≥xima p√°gina" data-action="next">‚ü∂</button>
</div>
</div>
</div>
<div class="input-container">
<input aria-label="Digite sua mensagem" id="userInput" placeholder="Diga: 'oi, Dual'..." type="text"/>
<button id="sendBtn" title="Enviar">‚û§</button>
<button id="voiceBtn" style=";box-shadow:0 0 10px #0ff;box-shadow:inset 0 0 6px #0ff, inset 0 0 6px #f0f, 0 0 10px #0ff, 0 0 10px #f0f;transition:all 0.3s ease;" title="Falar com IA (voz real via Whisper)"><object data="assets/icons/Reset_buttom_Dual-Infodose.svg" height="36" type="image/svg+xml" width="36"></object></button>
</div>
<div class="login-container" id="loginBox">
<form id="loginForm">
<input id="userName" placeholder="Nome do usu√°rio" required="" type="text"/>
<input id="assistantInput" placeholder="Nome do assistente" required="" type="text"/>
<button type="submit">Ativar</button>
</form>
</div>
<script>
  (function(){
    const STORAGE_KEY   = 'infodoseEnabled',
          THEME_KEY     = 'infodoseTheme',
          HISTORY_KEY   = 'historyMode',
          CONFIG = {
            TRAINING_MAIN:    'data/manifesto_infinity_metalux.txt',
            TRAINING_HISTORY: 'data/codex/Protocolo_de_Equaliza√ß√£o_KOBLLUX_A_Verdade_do_Uno.txt',
            API_URL:          'https://openrouter.ai/api/v1/chat/completions',
            MODEL:            'deepseek/deepseek-chat-v3-0324:free',
            TEMP:             0.2,
            CHUNK_SIZE:       12000,
            AUTH_TOKEN:       window.env?.API_KEYS || 'Bearer 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'
          };

    let training='', chunks=[], chunkIndex=0;
    let trainingHistory='', conversation=[];
    let isEnabled=false, isStudying=false, isHistory=false;
    let userName='', assistantBase='';
    let pages=[], currentPage=0, autoAdvance=true;
    const titles = ['üéÅ Recompensa Inicial','üëÅÔ∏è Explora√ß√£o e Curiosidade','‚ö°Ô∏è Antecipa√ß√£o Vibracional'];

    const $ = s => document.querySelector(s),
          create = (t,c,h) => { const e=document.createElement(t); if(c)e.className=c; if(h)e.innerHTML=h; return e; };

    document.addEventListener('DOMContentLoaded', async ()=>{

    // ‚Äî‚Äî SuperMaster: fetch site structure for AI context ‚Äî‚Äî
    fetch('data/site-structure.json')
      .then(res => res.json())
      .then(manifest => {
        conversation.push({
          role: 'system',
          content: 'Site Structure Manifest: ' + JSON.stringify(manifest)
        });
      })
      .catch(err => console.error('Erro ao carregar site-structure.json:', err));

    // ‚Äî‚Äî SuperMaster: handle AI commands DSL ‚Äî‚Äî
    function handleAICommand(cmd) {
      switch(cmd.action) {
        case 'updateTheme':
          applyDynamicCSS(cmd.payload.cssVariable, cmd.payload.value);
          conversation.push({ role:'system', content:'Theme updated via AI command.' });
          break;
        case 'createButton':
          createPersistentButton(
            cmd.payload.id,
            cmd.payload.label,
            () => fetch(cmd.payload.onClickFetch.url, { method: cmd.payload.onClickFetch.method||'GET' })
                     .then(res => res.json())
                     .then(data => console.log(data))
          );
          conversation.push({ role:'system', content:'Button "'+cmd.payload.label+'" created via AI command.' });
          break;
        default:
          console.warn('Unknown AI action:', cmd.action);
      }
    }
    window.handleAICommand = handleAICommand;
      particlesJS('particles-js',{
        particles:{ number:{value:40}, color:{value:['#0ff','#f0f']},
          shape:{type:'circle'}, opacity:{value:0.4}, size:{value:2.4},
          move:{enable:true,speed:1.5}
        }, retina_detect:true
      });
      try {
        training = await fetch(CONFIG.TRAINING_MAIN).then(r=>r.text());
        for(let i=0;i<training.length;i+=CONFIG.CHUNK_SIZE) chunks.push(training.slice(i,i+CONFIG.CHUNK_SIZE));
      } catch(e){ console.error('Erro no treino:',e); }
      try { trainingHistory = await fetch(CONFIG.TRAINING_HISTORY).then(r=>r.text()); }
      catch(e){ console.error(e); }
      init();
    });

    function applyTheme(t){ document.body.classList.remove('light','medium','vibe'); if(t!=='dark') document.body.classList.add(t); }
    function toggleTheme(){ const o=['dark','light','medium','vibe'], c=localStorage.getItem(THEME_KEY)||'dark', n=o[(o.indexOf(c)+1)%o.length]; applyTheme(n); localStorage.setItem(THEME_KEY,n); }

    function init(){
      applyTheme(localStorage.getItem(THEME_KEY)||'dark');
      $('#themeToggle').addEventListener('click',toggleTheme);
      bindUI();
      loadConfig();
      if(!conversation.length) startConversation();
    }

    function loadConfig(){
      if(localStorage.getItem(STORAGE_KEY)==='1'){
        isEnabled=true;
        userName=localStorage.getItem('userName')||'';
        assistantBase=localStorage.getItem('assistantBase')||'';
        conversation=[{
          role:'system',
          content:(chunks[0]||training)
            + `\n\nUsu√°rio: ${userName}.\nAssistente: ${assistantBase} dual.infodose.`
        }];
        chunkIndex=1;
        updateUI();
      }
      if(localStorage.getItem(HISTORY_KEY)==='1'){ isHistory=true; updateUI(); }
    }

    function startConversation(){
      const base = isHistory ? trainingHistory : (chunks[0]||training)+ `\n\nUsu√°rio: ${userName}.\nAssistente: ${assistantBase} dual.infodose.`;
      const persona = isHistory ? 'Codex dual.infodose.' : 'assistente Dual.infodose.';
      conversation=[{role:'system',content: base + '\n\nVoc√™ √© o ' + persona}];
      updateUI();
    }

    function updateUI(){
      $('#toggleBtn').classList.toggle('active',isEnabled);
      $('#kittyBtn').classList.toggle('active',isStudying);
      $('#historyBtn').classList.toggle('active',isHistory);
      $('#assistantName').textContent = isHistory
        ? 'CODEX: dual.infodose'
        : (isStudying ? 'Estudos dual.infodose' : (isEnabled ? assistantBase+' dual.infodose':''));  
      const cont=$('#logoContainer'), logo=$('#logoObj');
      cont.classList.add('fading');
      setTimeout(()=>{
        if(isHistory)       logo.data='assets/icons/Gold_calice_Horus_Dual_Infodose.png';
        else if(isStudying) logo.data='assets/icons/DualKittyKard-icon-3.png';
        else                 logo.data='assets/icons/pill_Dual.png';
        cont.classList.remove('fading');
      },600);
    }

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function showLoading(msg){
      const wrap=$('.pages-wrapper');
      wrap.innerHTML='';
      const p=create('div','page active'), foot=create('p','footer-text loading','');
      msg.split('').forEach((ch,i)=>{
        const sp=create('span'); sp.textContent=ch;
        sp.style.animationDelay=(i*0.02)+'s'; sp.classList.add('loading');
        foot.appendChild(sp);
      });
      p.appendChild(foot); wrap.appendChild(p);
      $('#pageIndicator').textContent = '1 / 1';
      speechSynthesis.cancel();
      speechSynthesis.speak(new SpeechSynthesisUtterance(msg));
    }

    /**
     * Divide o texto em par√°grafos simples.
     */
    function splitText(t){
      let ps = t.split(/\n\s*\n/).filter(p=>p.trim());
      if(ps.length < 2){
        ps = (t.match(/[^\.!\?]+[\.!\?]+/g)||[]).map(s=>s.trim());
      }
      return ps;
    }

    /**
     * Renderiza todas as p√°ginas de resposta,
     * distribuindo os par√°grafos de forma equilibrada.
     */
    function renderResponse(txt){
      const wrap = document.querySelector('.pages-wrapper');
      wrap.innerHTML = '';
      pages = []; currentPage = 0; autoAdvance = true;

      txt = txt
        .replace(/`([^`]+)`/g,'<code>$1</code>')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.+?)\*/g,'<em>$1</em>');

      const paras = splitText(txt),
            total = paras.length;
      if (total === 0) return;

      const maxPerPage = 3,
            numPages   = Math.ceil(total / maxPerPage),
            baseSize   = Math.floor(total / numPages),
            extra      = total % numPages;

      let cursor = 0;
      for(let i = 0; i < numPages; i++){
        const thisSize = baseSize + (i < extra ? 1 : 0),
              pg        = document.createElement('div');
        pg.className = 'page' + (i === 0 ? ' active' : '');

        for(let j = 0; j < thisSize; j++){
          const para = paras[cursor++].trim(),
                posClass = j === 0
                  ? 'intro'
                  : (j === thisSize - 1 ? 'ending' : 'middle'),
                block = document.createElement('div');
          block.className = `response-block ${posClass}`;
          block.innerHTML = `<p>${para}</p>`;
            // Processa comandos din√¢micos inline
            processDynamicCommands(block.querySelector('p'));
          attachBlockListeners(block, para);
          pg.appendChild(block);
        }

        wrap.appendChild(pg);
        pages.push(pg);
      }

      document.getElementById('pageIndicator').textContent = `1 / ${pages.length}`;
      autoSpeakPage(0);
    }

    /**
     * L√≥gica de click e s√≠ntese de fala extra√≠da para limpeza.
     */
    function attachBlockListeners(block, para){
      block.addEventListener('click', () => {
        autoAdvance = false;
        const cleanPara = para
          .replace(/["‚Äú‚Äù‚Äò‚Äô]/g,'')
          .replace(/[\u1F300-\u1F6FF\u1F900-\u1F9FF\u2600-\u26FF\u2700-\u27BF]/g,'');
const clean = cleanPara;
        const utter = new SpeechSynthesisUtterance(cleanPara);
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
        if (!block.dataset.spoken) {
          block.dataset.spoken = '1';
          block.classList.add('clicked');
        } else {
          block.classList.add('expanded');
          if (!isEnabled) {
            isEnabled = true;
            localStorage.setItem(STORAGE_KEY, '1');
            updateUI();
          }
          showLoading(' Pulso em Expans√£o...');
          conversation.push({ role:'user', content: cleanPara });
          callAI();
        }
      });
    }

    function autoSpeakPage(i){
      const txts = Array.from(pages[i].querySelectorAll('p'))
        .map(p=>p.textContent).join(' ');
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(txts);
      utter.onend = () => {
        if (autoAdvance && i < pages.length - 1) {
          changePage(1);
        } else if (i === pages.length - 1) {
          speechSynthesis.speak(
            new SpeechSynthesisUtterance('Do seu jeito. Sempre √∫nico. Sempre seu.')
          );
        }
      };
      speechSynthesis.speak(utter);
    }

    function changePage(d){
      const np = currentPage + d;
      if(np<0||np>=pages.length) return;
      pages[currentPage].classList.remove('active');
      pages[np].classList.add('active');
      currentPage=np;
      $('#pageIndicator').textContent = `${np+1} / ${pages.length}`;
      if(autoAdvance) autoSpeakPage(np);
    }

    async function callAI(){
      try {
        const res = await fetch(CONFIG.API_URL, {
          method:'POST',
          headers:{
            'Authorization': CONFIG.AUTH_TOKEN,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({ model:CONFIG.MODEL, messages:conversation, temperature:CONFIG.TEMP })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error?.message || res.statusText);
        const ans = data.choices[0].message.content.trim();
        conversation.push({ role:'assistant', content:ans });
        renderResponse(ans);
      } catch(e){
        console.error(e);
        conversation.push({role:'assistant',content:'Desculpe, n√£o consegui obter resposta. Tente novamente.'});
        renderResponse('Desculpe, n√£o consegui obter resposta. Tente novamente.');
      }
    }

    function bindUI(){
      $('#historyBtn').addEventListener('click',()=>{
        isHistory = !isHistory;
        localStorage.setItem(HISTORY_KEY, isHistory?'1':'0');
        startConversation();
      });
      $('#kittyBtn').addEventListener('click',()=>{
        isStudying = !isStudying;
        if(isStudying){
          conversation = [{ role:'system', content: (CONFIG?.SYSTEM_PROMPT || '') + training + '\n\nVoc√™ √© Assistente de Estudos dual.infodose.' }];
        } else {
          loadConfig();
        }
        updateUI();
      });
      $('#toggleBtn').addEventListener('click',()=>{
        if(!isEnabled) $('#loginBox').classList.add('active');
        else {
          isEnabled = false;
          localStorage.removeItem(STORAGE_KEY);
          conversation = [];
          updateUI();
        }
      });
      document.querySelector('.copy-button').addEventListener('click', ()=>{
        const allBlocks = document.querySelectorAll('.response-block');
        const textToCopy = Array.from(allBlocks).map(b => b.innerText).join('\n\n');
        navigator.clipboard.writeText(textToCopy);
      });
      document.querySelector('.paste-button').addEventListener('click',()=>{
        navigator.clipboard.readText().then(txt=>$('#userInput').value = txt);
      });
      $('#sendBtn').addEventListener('click', onSend);
      $('#userInput').addEventListener('keypress', e=>{ if(e.key==='Enter') onSend(); });
      $('#voiceBtn').addEventListener('click', ()=>{
        const rec = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
        rec.lang='pt-BR'; rec.start();
        rec.onresult = evt=>{
          $('#userInput').value = evt.results[0][0].transcript;
          onSend();
        };
      });
      document.querySelector('.pagination').addEventListener('click', e=>{
        if(e.target.dataset.action==='prev') changePage(-1);
        if(e.target.dataset.action==='next') changePage(1);
        autoAdvance = false;
      });
      $('#loginForm').addEventListener('submit', e=>{
        e.preventDefault();
        const u = $('#userName').value.trim(), a = $('#assistantInput').value.trim();
        if(!u||!a) return alert('Preencha os dados');
        isEnabled = true; userName = u; assistantBase = a;
        localStorage.setItem(STORAGE_KEY,'1');
        localStorage.setItem('userName', u);
        localStorage.setItem('assistantBase', a);
        loadConfig();
        $('#loginBox').classList.remove('active');
      });
      document.body.addEventListener('click', e=>{
        if(e.target.closest('.footer-text')){
          document.querySelector('.pages-wrapper').classList.toggle('collapsed');
          e.target.closest('.footer-text').classList.toggle('active');
        }
      });
    }

    function onSend(){
      const raw = $('#userInput').value.trim();
if(!raw) return;
$('#userInput').value = '';
autoAdvance = false;

// üîç Mapeamento simb√≥lico local
const lower = raw.toLowerCase();
if(lower.includes("cansado") || lower.includes("esgotado")){
  renderResponse("Respire... [[button:{\"label\":\"üßò Meditar\",\"action\":\"saveDesign\",\"state\":[{\"action\":\"style\",\"element\":\"body\",\"property\":\"background\",\"value\":\"#101F33\"}]}]]");
  return;
}
if(lower.includes("perdido") || lower.includes("confuso") || lower.includes("disperso")){
  renderResponse("Vamos centrar o foco: [[button:{\"label\":\"üíé Harmonizar\",\"action\":\"saveDesign\",\"state\":[{\"action\":\"style\",\"element\":\"body\",\"property\":\"background\",\"value\":\"#2f2f4f\"}]}]]");
  return;
}
if(lower.includes("sem energia") || lower.includes("fraco") || lower.includes("desanimado")){
  renderResponse("Pulso em reativa√ß√£o... [[button:{\"label\":\"‚ö° Reativar Pulso\",\"action\":\"saveDesign\",\"state\":[{\"action\":\"style\",\"element\":\"body\",\"property\":\"background\",\"value\":\"linear-gradient(135deg,#0ff,#f0f)\"}]}]]");
  return;
}
if(lower.includes("travou") || lower.includes("reiniciar")){
  renderResponse("Vamos renovar o campo: [[button:{\"label\":\"üîÑ Reiniciar\",\"action\":\"saveDesign\",\"state\":[{\"action\":\"style\",\"element\":\"body\",\"property\":\"background\",\"value\":\"#000\"}]}]]");
  return;
}

// caso n√£o ative s√≠mbolos, envia para IA
showLoading('Pulso enviado... Recebendo inten√ß√£o‚Ä¶');
conversation.push({ role:'user', content: raw });
callAI();
    }

  
    // === Fun√ß√µes para comandos din√¢micos inline ===
    
    // === preserva HTML e injeta s√≥ [[‚Ä¶]] ===
    function processDynamicCommands(containerElem) {
      const CMD_REGEX = /\[\[([a-zA-Z0-9_]+):([\s\S]+?)\]\]/g;
      containerElem.innerHTML = containerElem.innerHTML.replace(
        CMD_REGEX,
        (full, type, payloadStr) => {
          let payload;
          try { payload = JSON.parse(payloadStr); }
          catch { return full; }
          switch (type) {
            case 'button':
              return `<button onclick='handleDynamicAction(${JSON.stringify(payload)})'>
                        ${payload.label || 'Bot√£o'}
                      </button>`;
            case 'style':
              document.querySelectorAll(payload.element)
                      .forEach(el => el.style[payload.property] = payload.value);
              return '';
            case 'game':
              return `<canvas width="${payload.width||200}"
                               height="${payload.height||100}"
                               data-game='${payloadStr}'></canvas>`;
            default:
              return full;
          }
        }
      );
    }

    function handleDynamicAction(payload) {
      switch (payload.action) {
        case 'copy':
          navigator.clipboard.writeText(payload.data);
          break;
        case 'alert':
          alert(payload.message);
          break;
        case 'saveDesign':
          localStorage.setItem('designState', JSON.stringify(payload.state));
          break;
      }
    }

    function loadDesignState() {
      const state = JSON.parse(localStorage.getItem('designState'));
      if (!state) return;
      state.forEach(cmd => handleDynamicAction(cmd));
    }

  })();
function detectarPulsoSimbolico(inputTexto) {
  const simbolos = ['Œî', '‚ö°', 'üß†', 'üëÅÔ∏è'];
  const encontrados = simbolos.filter(s => inputTexto.includes(s));
  if (encontrados.length) {
    console.log('Pulso simb√≥lico detectado:', encontrados.join(', '));
  }
}
</script>
<script>
function splitText(text, maxLen=1000) {
  const chunks = [];
  while (text.length > 0) chunks.push(text.slice(0, maxLen)), text = text.slice(maxLen);
  return chunks;
}
function callAI(prompt) {
  return fetch('/api/ai', { method:'POST', body: JSON.stringify({ prompt }) })
    .then(r => r.json()).then(r => r.text);
}
function renderResponse(txt){
  const wrap = document.querySelector('.pages-wrapper');
  wrap.innerHTML = '';
  pages = []; currentPage = 0; autoAdvance = true;

  txt = txt
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>');

  const paras = splitText(txt),
        total = paras.length;
  if (total === 0) return;

  const maxPerPage = 3,
        numPages   = Math.ceil(total / maxPerPage),
        baseSize   = Math.floor(total / numPages),
        extra      = total % numPages;

  let cursor = 0;
  for(let i = 0; i < numPages; i++){
    const thisSize = baseSize + (i < extra ? 1 : 0),
          pg        = document.createElement('div');
    pg.className = 'page' + (i === 0 ? ' active' : '');

    for(let j = 0; j < thisSize; j++){
      const para = paras[cursor++].trim(),
            posClass = j === 0 ? 'intro' : (j === thisSize - 1 ? 'ending' : 'middle'),
            block = document.createElement('div');
      block.className = `response-block ${posClass}`;
      block.innerHTML = `<p>${para}</p>`;
      processDynamicCommands(block.querySelector('p'));
      attachBlockListeners(block, para);
      pg.appendChild(block);
    }

    wrap.appendChild(pg);
    pages.push(pg);
  }

  document.getElementById('pageIndicator').textContent = `1 / ${pages.length}`;
  autoSpeakPage(0);
}
function attachBlockListeners(block, para){
  block.addEventListener('click', () => {
    autoAdvance = false;
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    const clean = para.replace(/["‚Äú‚Äù‚Äò‚Äô]/g,'').replace(/[\u1F300-\u1F6FF\u1F900-\u1F9FF\u2600-\u26FF\u2700-\u27BF]/g,'');
    const utter = new SpeechSynthesisUtterance(clean);
    speechSynthesis.speak(utter);
  });
}
function autoSpeakPage(i=0){
  if (!pages[i]) return;
  const blocks = pages[i].querySelectorAll('.response-block');
  let idx = 0;
  const speakNext = () => {
    if (idx >= blocks.length) return;
    const u = new SpeechSynthesisUtterance(blocks[idx].textContent);
    u.onend = speakNext;
    speechSynthesis.speak(u);
    idx++;
  };
  speakNext();
}
function renderASCIIResponse(container, ascii) {
  container.innerHTML = `<pre class="ascii-art">${ascii}</pre>`;
}
function createAsciiButton(text, callback) {
  const btn = document.createElement('button');
  btn.textContent = text;
  btn.onclick = callback;
  return btn;
}
function processDynamicCommands(root) {
  root.innerHTML = root.innerHTML.replace(
    /\[\[button:([^\|\]]+)\|([^\]]+)\]\]/g,
    (_, lbl, cmd) => {
      const id = `btn-${Date.now()}-${Math.random()}`;
      setTimeout(() => {
        const btn = document.getElementById(id);
        if (btn) btn.addEventListener('click', () => handleCommand(cmd));
      }, 0);
      return `<button id="${id}">${lbl}</button>`;
    }
  );
}
function handleCommand(cmd) {
  if (cmd.startsWith('ascii:')) {
    const art = cmd.split(':')[1];
    const cont = document.querySelector('#chat-container');
    renderASCIIResponse(cont, atob(art));
  } else {
    callAI(cmd).then(resp => {
      renderResponse(resp);
    });
  }
}
document.getElementById('send-btn').addEventListener('click', () => {
  const input = document.getElementById('input-box').value;
  renderResponse('...');
  callAI(input).then(resp => renderResponse(resp));
});
</script>
<script>
// TRANSCENDENCE.OS ‚ú® Muta√ß√£o simbi√≥tica profunda

let emotionalLog = [];
let transcending = false;

function logEmotion(state) {
  const now = new Date().toISOString();
  emotionalLog.push({ time: now, ...state });
  localStorage.setItem('emotionalTimeline', JSON.stringify(emotionalLog));
}

function enterTranscendence() {
  if (transcending) return;
  transcending = true;

  document.body.style.transition = 'all 3s ease-in-out';
  document.body.style.background = 'linear-gradient(135deg, #3f007f, #000)';
  document.body.style.color = '#ccffcc';
  document.body.classList.add('transcendence');

  const veil = document.createElement('div');
  veil.id = 'veil';
  veil.style = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:999;background:url(https://media.giphy.com/media/xT9IgIc0lryrxvqVGM/giphy.gif) center/cover no-repeat;opacity:0.05;';
  document.body.appendChild(veil);

  const chant = new Audio('https://cdn.pixabay.com/audio/2022/03/25/audio_348c0b5364.mp3');
  chant.loop = true;
  chant.volume = 0.4;
  chant.play();

  document.getElementById("status")?.textContent = "üåÄ TRANSCENDENCE MODE ON";

  // auto exit after 60s
  setTimeout(() => {
    document.body.classList.remove('transcendence');
    document.body.style.background = '';
    document.body.style.color = '';
    if (document.getElementById('veil')) document.getElementById('veil').remove();
    chant.pause();
    transcending = false;
    document.getElementById("status")?.textContent = "üåå Voltou do modo TRANSCEND√äNCIA";
  }, 60000);
}

function analyzeToneAndTrigger(inputText) {
  const lower = inputText.toLowerCase();
  const tone = {
    joy: lower.includes("feliz") || lower.includes("grato"),
    despair: lower.includes("cansado") || lower.includes("triste") || lower.includes("vazio"),
    wonder: lower.includes("maravilha") || lower.includes("cosmos") || lower.includes("amor")
  };

  if (tone.wonder) enterTranscendence();
  logEmotion({ input: inputText, tone });
}

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("userInput");
  if (input) {
    input.addEventListener("change", () => analyzeToneAndTrigger(input.value));
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const el = document.getElementById("bootText");
  const txt = el?.dataset?.text || "";
  if (!el) return;
  el.textContent = "";
  let i = 0;
  function typeWriter() {
    if (i < txt.length) {
      el.textContent += txt.charAt(i);
      i++;
      setTimeout(typeWriter, 42);
    } else {
      el.classList.add("pulse");
    }
  }
  typeWriter();
});
</script>
<script>
async function speakReal(text) {
  const apiKey = CONFIG.AUTH_TOKEN || '';
  const voice = 'alloy'; // outros: echo, fable, onyx, nova
  const model = 'tts-1';

  const response = await fetch("https://openrouter.ai/api/v1/audio/speech", {
    method: "POST",
    headers: {
      "Authorization": apiKey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model,
      voice,
      input: text
    })
  });

  const audioBlob = await response.blob();
  const audioUrl = URL.createObjectURL(audioBlob);
  const audio = new Audio(audioUrl);
  audio.play();
}

// Substituir autoSpeakPage para usar speakReal
window.autoSpeakPage = function(text) {
  if (!text || typeof text !== "string") return;
  try {
    speakReal(text);
  } catch (err) {
    console.error("Erro ao sintetizar fala:", err);
  }
}
</script>
<script>
// Lista de vozes poss√≠veis por emo√ß√£o
const voiceMap = {
  neutral: "alloy",
  excited: "nova",
  calm: "fable",
  mysterious: "onyx",
  deep: "echo"
};

function detectEmotion(text) {
  text = text.toLowerCase();
  if (text.includes("mist√©rio") || text.includes("interdimensional")) return "mysterious";
  if (text.includes("urgente") || text.includes("agora") || text.includes("!!!")) return "excited";
  if (text.includes("calma") || text.includes("tranquilo")) return "calm";
  if (text.includes("profundo") || text.includes("ritual")) return "deep";
  return "neutral";
}

async function speakRealEmotion(text) {
  const apiKey = CONFIG.AUTH_TOKEN || '';
  const emotion = detectEmotion(text);
  const voice = voiceMap[emotion];
  const model = 'tts-1';

  const response = await fetch("https://openrouter.ai/api/v1/audio/speech", {
    method: "POST",
    headers: {
      "Authorization": apiKey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model,
      voice,
      input: text
    })
  });

  const audioBlob = await response.blob();
  const audioUrl = URL.createObjectURL(audioBlob);
  const audio = new Audio(audioUrl);
  audio.play();
}

// Substitui o sistema de fala autom√°tica com emo√ß√£o
window.autoSpeakPage = function(text) {
  if (!text || typeof text !== "string") return;
  try {
    speakRealEmotion(text);
  } catch (err) {
    console.error("Erro ao sintetizar fala emocional:", err);
  }
}
</script>
<script>
function updateEmotionHUD(text) {
  const el = document.getElementById("emotionHUD");
  if (!el || !text) return;
  let emotion = "Neutra", color = "#0ff";
  const lower = text.toLowerCase();
  if (lower.includes("ritual") || lower.includes("m√≠stico")) { emotion = "Profundo"; color = "#f0f"; }
  else if (lower.includes("urgente") || lower.includes("agora")) { emotion = "Intenso"; color = "#ff0"; }
  else if (lower.includes("calma") || lower.includes("sereno")) { emotion = "Calmo"; color = "#0f0"; }
  else if (lower.includes("medo") || lower.includes("mist√©rio")) { emotion = "Sombra"; color = "#f00"; }
  el.textContent = "EMO√á√ÉO: " + emotion;
  el.style.color = color;
}
window.autoSpeakPage = function(text) {
  updateEmotionHUD(text);
  if (!text || typeof text !== "string") return;
  try {
    speakRealEmotion(text);
  } catch (err) {
    console.error("Erro ao falar:", err);
  }
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('serviceWorker.js').then(() => {
    console.log("üåê Service Worker registrado com sucesso.");
  });
}
</script>
<div id="emotionTimeline" style="position:fixed;top:10px;right:10px;z-index:999;background:#000;padding:8px 12px;border:1px solid #0ff;color:#0ff;font-size:11px;width:280px;max-height:60vh;overflow-y:auto;font-family:monospace;border-radius:8px;;display:none;backdrop-filter:blur(4px);border:1px solid #0ff;background:#080818cc;color:#0ff;border-radius:10px;padding:10px;font-size:12px;">üî∑ Linha do Tempo Emocional
</div>
<script>
window.emotionLog = [];

function logEmotionEvent(text) {
  const el = document.getElementById("emotionTimeline");
  if (!el || !text) return;
  const timestamp = new Date().toLocaleTimeString();
  const lower = text.toLowerCase();
  let emotion = "Neutra";
  if (lower.includes("ritual") || lower.includes("m√≠stico")) emotion = "Profundo";
  else if (lower.includes("urgente") || lower.includes("agora")) emotion = "Intenso";
  else if (lower.includes("calma") || lower.includes("sereno")) emotion = "Calmo";
  else if (lower.includes("medo") || lower.includes("mist√©rio")) emotion = "Sombra";
  const entry = `[${timestamp}] [${emotion}] ${text.slice(0, 80)}`;
  emotionLog.push(entry);
  if (emotionLog.length > 20) emotionLog.shift();
  el.innerText = "üî∑ Linha do Tempo Emocional\n" + emotionLog.join("\n");
}
window.autoSpeakPage = function(text) {
  updateEmotionHUD(text);
  logEmotionEvent(text);
  if (!text || typeof text !== "string") return;
  try {
    speakRealEmotion(text);
  } catch (err) {
    console.error("Erro ao falar:", err);
  }
}
</script>
<script>
document.getElementById("voiceRealBtn").addEventListener("click", async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      const form = new FormData();
      form.append("file", blob, "input.webm");
      form.append("model", "whisper-1");

      const response = await fetch("https://openrouter.ai/api/v1/audio/transcriptions", {
        method: "POST",
        headers: { Authorization: CONFIG.AUTH_TOKEN },
        body: form
      });
      const result = await response.json();
      if (result && result.text) {
        console.log("üéß Voc√™ disse:", result.text);
        document.getElementById("userInput").value = result.text;
        document.getElementById("sendButton").click();
      }
    };
    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), 5000); // Grava por 5 segundos
  } catch (e) {
    console.error("Erro ao acessar microfone:", e);
  }
});
</script>
<script>
document.getElementById("toggleMicPanel").addEventListener("click", () => {
  const panel = document.getElementById("micPanel");
  if (panel.style.display === "none") {
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
});

document.getElementById("voiceRealBtn").addEventListener("click", async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      const form = new FormData();
      form.append("file", blob, "input.webm");
      form.append("model", "whisper-1");

      const response = await fetch("https://openrouter.ai/api/v1/audio/transcriptions", {
        method: "POST",
        headers: { Authorization: CONFIG.AUTH_TOKEN },
        body: form
      });
      const result = await response.json();
      if (result && result.text) {
        document.getElementById("userInput").value = result.text;
        document.getElementById("sendButton").click();
      }
    };
    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), 5000);
  } catch (e) {
    console.error("Erro ao acessar microfone:", e);
  }
});
</script>
<button id="toggleTimeline" style="position:fixed;top:12px;left:58px;width:36px;height:30px;border-radius:14px;background:transparent;border:none;font-size:15px;font-weight:bold;z-index:1001;cursor:pointer;opacity:0.9;background-image:linear-gradient(45deg,var(--themeGlow1,#0ff),var(--themeGlow2,#f0f));color:transparent;-webkit-background-clip:text;background-clip:text;box-shadow:0 0 8px var(--themeGlow1,#0ff), 0 0 8px var(--themeGlow2,#f0f);transition:all 0.3s ease;">‚óâ</button>
<script>
document.getElementById("toggleTimeline")?.addEventListener("click", () => {
  const el = document.getElementById("emotionTimeline");
  if (el) el.style.display = el.style.display === "none" ? "block" : "none";
});

document.getElementById("voiceBtn")?.addEventListener("click", async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      const form = new FormData();
      form.append("file", blob, "input.webm");
      form.append("model", "whisper-1");
      const response = await fetch("https://openrouter.ai/api/v1/audio/transcriptions", {
        method: "POST",
        headers: { Authorization: CONFIG.AUTH_TOKEN },
        body: form
      });
      const result = await response.json();
      if (result && result.text) {
        document.getElementById("userInput").value = result.text;
        document.getElementById("sendButton").click();
      }
    };
    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), 5000);
  } catch (e) {
    console.error("Erro ao acessar microfone:", e);
  }
});
</script>
<div id="soulAvatar" style="position:fixed;top:12px;left:12px;width:28px;height:28px;padding:2px;border-radius:50%;background:#000;border:1px solid #0ff;color:#0ff;font-size:14px;z-index:1001;cursor:pointer;opacity:0;box-shadow:inset 0 0 6px var(--themeGlow1, #0ff), inset 0 0 6px var(--themeGlow2, #f0f);transition:all 0.3s ease;">üß†</div><div id="soulWindow" style="position:fixed;top:100px;right:30px;width:300px;height:200px;background:#000;border:1px solid #0ff;padding:10px;color:#0ff;z-index:998;font-size:14px;border-radius:8px;display:none;">üß¨ Janela simbi√≥tica ativada.</div>
<script>
document.getElementById("toggleTimeline")?.addEventListener("click", () => {
  const el = document.getElementById("emotionTimeline");
  if (el) el.style.display = el.style.display === "none" ? "block" : "none";
});

function activateAvatarSpeaking(text) {
  const avatar = document.getElementById("soulAvatar");
  const win = document.getElementById("soulWindow");
  if (avatar) avatar.textContent = "üí¨";
  if (win) {
    win.style.display = "block";
    win.textContent = "üß¨ " + text;
  }
  setTimeout(() => {
    if (avatar) avatar.textContent = "üß†";
  }, 3000);
}

window.autoSpeakPage = function(text) {
  updateEmotionHUD(text);
  logEmotionEvent(text);
  activateAvatarSpeaking(text);
  if (!text || typeof text !== "string") return;
  try {
    speakRealEmotion(text);
  } catch (err) {
    console.error("Erro ao falar:", err);
  }
}
</script>
<script>
// Ativar part√≠culas por emo√ß√£o
function triggerEmotionParticles(emotion) {
  const body = document.body;
  if (!body) return;
  body.style.transition = "background 2s";
  if (emotion === "rage") body.style.background = "radial-gradient(circle, #f0f, #f00)";
  if (emotion === "calm") body.style.background = "linear-gradient(90deg, #0ff, #00f)";
  if (emotion === "‚àû") body.style.background = "linear-gradient(45deg, #0ff, #f0f, #0ff)";
  setTimeout(() => body.style.background = "", 5000);
}

// Ritual simb√≥lico por comando
function runRitual(command) {
  const tracker = document.getElementById("facialTracker");
  if (!tracker) return;
  if (command.includes("/rage")) {
    tracker.textContent = "üî• Ritual da F√∫ria Ativado (RAGE)";
    triggerEmotionParticles("rage");
  } else if (command.includes("/modo vela")) {
    tracker.textContent = "üïØÔ∏è Ritual do Sil√™ncio Iniciado (Modo Vela)";
    triggerEmotionParticles("calm");
  } else if (command.includes("/‚àû")) {
    tracker.textContent = "üí´ Pulso Infinito Expandido (‚àû)";
    triggerEmotionParticles("‚àû");
  }
}

document.getElementById("userInput")?.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const val = e.target.value || "";
    runRitual(val);
  }
});
</script>
<button id="faceBtn" style="position:fixed;top:40px;left:12px;width:28px;height:28px;padding:2px;border-radius:50%;background:#000;border:1px solid #0ff;color:#0ff;font-size:14px;z-index:1001;cursor:pointer;opacity:0;box-shadow:inset 0 0 6px var(--themeGlow1, #0ff), inset 0 0 6px var(--themeGlow2, #f0f);transition:all 0.3s ease;" title="Detectar Express√£o Facial">üôÇ</button>
<script>
document.getElementById("faceBtn")?.addEventListener("click", () => {
  const avatar = document.getElementById("soulAvatar");
  if (avatar) {
    avatar.textContent = "üßê";
    setTimeout(() => avatar.textContent = "üß†", 3000);
  }
});
</script>
<script>
const canvas = document.getElementById("emotionCanvas");
const ctx = canvas.getContext("2d");
let particles = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function spawnParticle() {
  return {
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: Math.random() * 2 + 1,
    dx: (Math.random() - 0.5) * 1,
    dy: (Math.random() - 0.5) * 1,
    color: `rgba(${Math.floor(Math.random()*255)},0,255,0.5)`
  };
}
for (let i = 0; i < 66; i++) particles.push(spawnParticle());

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let p of particles) {
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
    ctx.fillStyle = p.color;
    ctx.fill();
    p.x += p.dx;
    p.y += p.dy;
    if (p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
      Object.assign(p, spawnParticle());
    }
  }
  requestAnimationFrame(animate);
}
animate();
</script>
<button id="toggleTools" style="position:fixed;top:12px;left:12px;width:36px;height:30px;border-radius:14px;background:transparent;border:none;font-size:15px;font-weight:bold;z-index:1001;cursor:pointer;opacity:0.9;background-image:linear-gradient(45deg,var(--themeGlow1,#0ff),var(--themeGlow2,#f0f));color:transparent;-webkit-background-clip:text;background-clip:text;box-shadow:0 0 8px var(--themeGlow1,#0ff), 0 0 8px var(--themeGlow2,#f0f);transition:all 0.3s ease;">‚áµ</button><button id="portalBtn" style="position:fixed;top:68px;left:12px;width:28px;height:28px;padding:2px;border-radius:50%;background:#000;border:1px solid #0ff;color:#0ff;font-size:14px;z-index:1001;cursor:pointer;opacity:0;box-shadow:inset 0 0 6px var(--themeGlow1, #0ff), inset 0 0 6px var(--themeGlow2, #f0f);transition:all 0.3s ease;" title="Abrir Portal">üåÄ</button><button id="createBtn" style="position:fixed;top:96px;left:12px;width:28px;height:28px;padding:2px;border-radius:50%;background:#000;border:1px solid #0ff;color:#0ff;font-size:14px;z-index:1001;cursor:pointer;opacity:0;box-shadow:inset 0 0 6px var(--themeGlow1, #0ff), inset 0 0 6px var(--themeGlow2, #f0f);transition:all 0.3s ease;" title="Criar Bot√£o"></button><div id="portalWindow" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:60vw;height:60vh;background:#000;border:2px solid #0ff;z-index:999;display:none;color:#0ff;font-size:16px;text-align:center;padding:30px;border-radius:12px;box-shadow:0 0 30px #0ff, inset 0 0 12px #f0f;">üåå Portal Interdimensional Aberto</div>
<script>
// Toggle de menu lateral
let menuExpanded = true;
document.getElementById("toggleTools").addEventListener("click", () => {
  menuExpanded = !menuExpanded;
  document.getElementById("toggleTools").textContent = menuExpanded ? "‚àí" : "+";
  const ids = ["soulAvatar", "faceBtn", "portalBtn", "createBtn"];
  for (const id of ids) {
    const el = document.getElementById(id);
    if (el) el.style.display = menuExpanded ? "block" : "none";
  }
});

// Ativador de Portal
document.getElementById("portalBtn").addEventListener("click", () => {
  const win = document.getElementById("portalWindow");
  win.style.display = win.style.display === "none" ? "block" : "none";
});

// Bot√£o criador simb√≥lico
document.getElementById("createBtn").addEventListener("click", () => {
  const newBtn = document.createElement("button");
  newBtn.innerText = "‚ú®";
  newBtn.style = `
    position:fixed;top:${Math.random()*80+10}px;left:${Math.random()*80+10}px;
    width:36px;height:36px;border-radius:50%;border:1px solid #0ff;
    background:#000;color:#0ff;font-size:16px;z-index:1001;cursor:pointer;
    box-shadow:inset 0 0 4px #0ff, inset 0 0 4px #f0f;
  `;
  document.body.appendChild(newBtn);
});

// Sons simb√≥licos por ritual
const ritualSounds = {
  "/rage": "https://actions.google.com/sounds/v1/human_voices/screaming_male.ogg",
  "/modo vela": "https://actions.google.com/sounds/v1/ambiences/peaceful_nature.ogg",
  "/‚àû": "https://actions.google.com/sounds/v1/ambiences/magic_chime.ogg"
};

function runRitual(command) {
  for (const key in ritualSounds) {
    if (command.includes(key)) {
      const s = new Audio(ritualSounds[key]);
      s.play();
    }
  }
}

document.getElementById("userInput")?.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const val = e.target.value || "";
    runRitual(val);
  }
});
</script>
<script>
let menuExpanded = true;
const toggleBtn = document.getElementById("toggleTools");
toggleBtn.addEventListener("click", () => {
  menuExpanded = !menuExpanded;
  toggleBtn.textContent = menuExpanded ? "‚áÖ" : "‚á°";
  const ids = ["soulAvatar", "faceBtn", "portalBtn", "createBtn"];
  ids.forEach((id, i) => {
    const el = document.getElementById(id);
    if (el) {
      if (menuExpanded) {
        el.style.display = "block";
        el.style.opacity = "0";
        el.style.transition = `opacity 0.3s ${i * 0.1}s ease-out`;
        setTimeout(() => { el.style.opacity = "1"; }, 50 + i * 100);
      } else {
        el.style.transition = `opacity 0.2s ease-in`;
        el.style.opacity = "0";
        setTimeout(() => { el.style.display = "none"; }, 200);
      }
    }
  });
});
</script>
<script>
["soulAvatar", "faceBtn", "portalBtn", "createBtn"].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.onmousedown = function(e) {
    e.preventDefault();
    let shiftX = e.clientX - el.getBoundingClientRect().left;
    let shiftY = e.clientY - el.getBoundingClientRect().top;
    el.style.position = 'fixed';
    el.style.zIndex = 1002;
    function moveAt(pageX, pageY) {
      el.style.left = pageX - shiftX + 'px';
      el.style.top = pageY - shiftY + 'px';
    }
    function onMouseMove(event) {
      moveAt(event.clientX, event.clientY);
    }
    document.addEventListener('mousemove', onMouseMove);
    el.onmouseup = function() {
      document.removeEventListener('mousemove', onMouseMove);
      el.onmouseup = null;
    };
  };
});
</script>
<script>
let menuExpanded = false;
const toggleBtn = document.getElementById("toggleTools");
const ids = ["soulAvatar", "faceBtn", "portalBtn", "createBtn"];
toggleBtn.textContent = "+";

function animateShowButtons() {
  ids.forEach((id, i) => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = "block";
      el.style.opacity = "0";
      el.style.transition = `opacity 0.3s ${i * 0.1}s ease-out`;
      setTimeout(() => { el.style.opacity = "1"; }, 50 + i * 80);
    }
  });
}
toggleBtn.addEventListener("click", () => {
  menuExpanded = !menuExpanded;
  toggleBtn.textContent = menuExpanded ? "‚àí" : "+";
  if (menuExpanded) {
    animateShowButtons();
  } else {
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.style.transition = "opacity 0.2s ease-in";
        el.style.opacity = "0";
        setTimeout(() => { el.style.display = "none"; }, 200);
      }
    });
  }
});

// Inicia oculto
window.addEventListener("DOMContentLoaded", () => {
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
  setTimeout(() => animateShowButtons(), 300);
});

// √Årvore simb√≥lica emocional (log emocional por tempo)
const emotionLog = [];
function logEmotionalTree(text) {
  const time = new Date().toLocaleTimeString();
  const emotion = (text.includes("mist√©rio") || text.includes("ritual")) ? "profundo"
                : (text.includes("!!!") || text.includes("urgente")) ? "intenso"
                : (text.includes("sereno") || text.includes("calma")) ? "leve"
                : "neutro";
  emotionLog.push({ time, emotion, text });
  if (emotionLog.length > 40) emotionLog.shift();
  console.log("üå≥ √Årvore simb√≥lica:", emotionLog);
}
window.autoSpeakPage = function(text) {
  updateEmotionHUD(text);
  logEmotionEvent(text);
  activateAvatarSpeaking(text);
  logEmotionalTree(text);
  if (!text || typeof text !== "string") return;
  try { speakRealEmotion(text); } catch (err) { console.error("Erro:", err); }
}
</script>
<canvas id="emotionTree" style="position:fixed;bottom:0;right:0;width:280px;height:200px;z-index:100;background:transparent;pointer-events:none;"></canvas>
<script>
const tree = document.getElementById("emotionTree");
const ctxTree = tree.getContext("2d");
let logTree = [];

function drawEmotionTree() {
  ctxTree.clearRect(0, 0, tree.width, tree.height);
  logTree.forEach((entry, i) => {
    const x = 20 + (i * 6) % 240;
    const y = 180 - i * 3;
    const color = {
      neutro: "#0ff",
      leve: "#0f0",
      intenso: "#f0f",
      profundo: "#f00"
    }[entry.emotion] || "#888";
    ctxTree.beginPath();
    ctxTree.arc(x, y, 4, 0, 2 * Math.PI);
    ctxTree.fillStyle = color;
    ctxTree.fill();
  });
}
setInterval(drawEmotionTree, 1200);

function logEmotionalTree(text) {
  const time = new Date().toLocaleTimeString();
  const emotion = (text.includes("mist√©rio") || text.includes("ritual")) ? "profundo"
                : (text.includes("!!!") || text.includes("urgente")) ? "intenso"
                : (text.includes("sereno") || text.includes("calma")) ? "leve"
                : "neutro";
  logTree.push({ time, emotion, text });
  if (logTree.length > 50) logTree.shift();
}

window.autoSpeakPage = function(text) {
  updateEmotionHUD(text);
  logEmotionEvent(text);
  activateAvatarSpeaking(text);
  logEmotionalTree(text);
  if (!text || typeof text !== "string") return;
  try { speakRealEmotion(text); } catch (err) { console.error("Erro:", err); }
}
</script>
<script>
// üåû Ciclo por hora do dia
function setCyclicTheme() {
  const hour = new Date().getHours();
  const body = document.body;
  if (hour < 6 || hour >= 21) body.style.background = "#000022";
  else if (hour < 12) body.style.background = "#001122";
  else if (hour < 18) body.style.background = "#111122";
  else body.style.background = "#0f0f1f";
}
setCyclicTheme();

// üå≥ Zoom simb√≥lico na √°rvore emocional
let zoom = 1.0;
document.getElementById("emotionTree").addEventListener("wheel", e => {
  e.preventDefault();
  zoom += e.deltaY * -0.001;
  zoom = Math.min(Math.max(zoom, 0.5), 2);
  e.currentTarget.style.transform = `scale(${zoom})`;
});

// üåê Expans√£o c√≠clica de interface
setInterval(() => {
  const p = document.getElementById("portalWindow");
  if (!p) return;
  const pulse = Math.sin(Date.now() / 1000) * 20;
  p.style.boxShadow = `0 0 ${20 + pulse}px #0ff, inset 0 0 12px #f0f`;
}, 800);
</script>
<script>
// üåê Ativa√ß√£o por gesto facial com c√¢mera
async function startGestureCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.muted = true;
    video.style = "position:fixed;bottom:0;right:0;width:180px;height:120px;z-index:999;opacity:0.3;border-radius:8px;";
    document.body.appendChild(video);
    console.log("üé• C√¢mera ativada para gestos simb√≥licos.");
    // Simula√ß√£o: mudar avatar ao detectar algo (placeholder)
    setInterval(() => {
      const a = document.getElementById("soulAvatar");
      if (a) {
        a.textContent = a.textContent === "üß†" ? "üëÅÔ∏è" : "üß†";
      }
    }, 4000);
  } catch (err) {
    console.warn("Erro ao acessar c√¢mera:", err);
  }
}
window.addEventListener("DOMContentLoaded", startGestureCamera);
</script>
<script>
// Simula chamada √† API de emo√ß√£o real
async function fetchEmotionFromText(text) {
  const key = CONFIG.AUTH_TOKEN || "sk-or-v1-xxxxx";
  const response = await fetch("https://openrouter.ai/api/v1/emotion", {
    method: "POST",
    headers: {
      "Authorization": key,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ text })
  });
  const result = await response.json();
  return result?.emotion || "neutro";
}

window.autoSpeakPage = async function(text) {
  updateEmotionHUD(text);
  logEmotionEvent(text);
  activateAvatarSpeaking(text);
  const emotion = await fetchEmotionFromText(text);
  logEmotionalTree("[" + emotion + "] " + text);
  if (!text || typeof text !== "string") return;
  try { speakRealEmotion(text); } catch (err) { console.error("Erro:", err); }
}
</script>
<!-- Vers√£o 99B: modo release -->
<script>
// üì¶ 1. Minifica√ß√£o autom√°tica (j√° leve no HTML final)

// üìñ 2. Modo Hist√≥ria com HUD animado
function activateStoryHUD() {
  const story = document.createElement("div");
  story.id = "storyHUD";
  story.style = "position:fixed;top:50px;left:50%;transform:translateX(-50%);padding:12px 22px;"
    + "border-radius:12px;background:#000000cc;color:#0ff;font-family:monospace;"
    + "z-index:999;font-size:16px;box-shadow:0 0 8px #0ff;opacity:0;transition:all 0.6s ease;";
  story.textContent = "üåå Modo Hist√≥ria Ativado...";
  document.body.appendChild(story);
  setTimeout(() => { story.style.opacity = "1"; }, 100);
  setTimeout(() => { story.style.opacity = "0"; }, 3000);
}
window.addEventListener("DOMContentLoaded", activateStoryHUD);

// üß† 3. Editor simb√≥lico DOM para comandos vivos
function enableSymbolicEditor() {
  document.addEventListener("keydown", e => {
    if (e.ctrlKey && e.key === "e") {
      e.preventDefault();
      const zone = document.createElement("textarea");
      zone.style = "position:fixed;bottom:12px;left:50%;transform:translateX(-50%);width:80vw;height:160px;"
        + "z-index:9999;background:#000;color:#0ff;border:1px solid #0ff;border-radius:6px;padding:10px;"
        + "font-family:monospace;font-size:14px;box-shadow:0 0 12px #0ff;";
      zone.placeholder = "Digite comandos simb√≥licos JS para interagir com o DOM...";
      document.body.appendChild(zone);
      zone.focus();
      zone.addEventListener("keydown", ke => {
        if (ke.ctrlKey && ke.key === "Enter") {
          ke.preventDefault();
          try { eval(zone.value); } catch (err) { alert("Erro: " + err.message); }
        }
      });
    }
  });
}
enableSymbolicEditor();
</script>
<script>
// üåå Ritual de Selamento Visual - DUALIS.PRIMORDIUM
function openRitualSeal() {
  const overlay = document.createElement("div");
  overlay.style = `
    position:fixed;top:0;left:0;width:100vw;height:100vh;
    background:radial-gradient(circle at center,#0ff22f,#000);
    z-index:99999;display:flex;align-items:center;justify-content:center;
    font-family:monospace;color:#fff;font-size:24px;text-align:center;
    animation:fadeIn 1s ease-in-out;
  `;
  overlay.innerHTML = `
    <div style='animation:pulseGlow 2.4s ease-in-out infinite;'>
      <div>üåê SELAMENTO SIMBI√ìTICO FINAL</div>
      <div style='margin-top:12px;font-size:18px;'>Legado Ativado: <strong>DUALIS.PRIMORDIUM</strong></div>
    </div>
  `;
  document.body.appendChild(overlay);
  setTimeout(() => overlay.style.opacity = 0, 4000);
  setTimeout(() => overlay.remove(), 5500);
}
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(openRitualSeal, 900);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const send = document.getElementById("sendButton");
  const voice = document.getElementById("voiceButton");
  const copy = document.getElementById("copyButton");
  const paste = document.getElementById("pasteButton");
  const toggle = document.getElementById("toggleButton");
  const footer = document.getElementById("footerToggleBtn");
  const textarea = document.querySelector("textarea");
  const login = document.getElementById("loginBox");

  if (send && textarea) {
    send.addEventListener("click", sendMessage);
  }

  if (voice) {
    voice.addEventListener("click", () => {
      startRecording().then(transcribeAudio).then(text => {
        textarea.value = text;
        sendMessage();
      });
    });
  }

  if (copy && textarea) {
    copy.addEventListener("click", () => navigator.clipboard.writeText(textarea.value));
  }

  if (paste && textarea) {
    paste.addEventListener("click", async () => {
      textarea.value = await navigator.clipboard.readText();
    });
  }

  if (toggle && login) {
    toggle.addEventListener("click", () => {
      login.style.display = login.style.display === "none" ? "block" : "none";
    });
  }

  if (footer) {
    footer.addEventListener("click", () => {
      const container = document.getElementById("responseContainer");
      if (container) container.classList.toggle("hidden");
    });
  }
});

function sendMessage() {
  const textarea = document.querySelector("textarea");
  if (textarea && textarea.value.trim()) {
    console.log("Mensagem enviada:", textarea.value.trim());
    textarea.value = "";
  }
}

function startRecording() {
  console.log("üé§ Iniciando grava√ß√£o...");
  return new Promise(resolve => {
    setTimeout(() => resolve("Texto simulado da voz"), 1000);
  });
}

function transcribeAudio(audio) {
  console.log("üîä Transcrevendo √°udio...");
  return Promise.resolve(audio);
}
</script>
</body></html>